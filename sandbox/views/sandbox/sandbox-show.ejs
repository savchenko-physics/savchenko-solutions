<%- include('../partials/header') %>

<div class="mb-3">
  <h2><%= solution.title %></h2>
  <p><strong>By:</strong> <%= solution.author || 'Anonymous' %></p>
  <p><strong>Subject:</strong> <%= solution.subject %></p>
  <p><strong>Difficulty:</strong> <%= solution.difficulty %></p>
  <p><strong>Status:</strong> <%= solution.status %></p>
  <p><strong>Posted:</strong> <%= solution.created_at %></p>
  <hr />
  <h4>Solution Content:</h4>
  
  <!-- Display LaTeX content if method is latex -->
  <% if (solution.method === 'latex') { %>
    <p><%= solution.content %></p>
  <% } %>

  <!-- Display uploaded images -->
  <% if (solution.files && solution.files.length > 0) { %>
    <div class="solution-images d-flex flex-wrap gap-3 mb-3">
      <% solution.files.forEach((file, index) => { %>
        <div class="position-relative image-wrapper">
          <img 
            src="/uploads/<%= file %>" 
            alt="Solution image <%= index + 1 %>"
            class="img-thumbnail cursor-pointer"
            style="height: 200px; object-fit: contain;"
            onclick="showImagePreview(this, <%= index %>)"
          />
        </div>
      <% }); %>
    </div>
  <% } %>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body p-0 position-relative">
        <!-- Navigation buttons -->
        <button type="button" class="btn btn-light position-absolute top-50 start-0 translate-middle-y rounded-circle ms-3" id="prevImage">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button type="button" class="btn btn-light position-absolute top-50 end-0 translate-middle-y rounded-circle me-3" id="nextImage">
          <i class="bi bi-chevron-right"></i>
        </button>
        
        <!-- Close button -->
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
        
        <!-- Image container -->
        <div class="text-center" style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
          <img id="previewModalImage" src="" alt="Preview" class="img-fluid" style="max-height: 80vh; cursor: zoom-in;">
        </div>
        
        <!-- Image counter -->
        <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3 px-3 py-1 bg-dark bg-opacity-75 rounded-pill text-white">
          <span id="imageCounter">1/1</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Voting form -->
<div class="mb-3">
  <div class="d-flex align-items-center gap-3">
    <form action="/sandbox/<%= solution.id %>/vote" method="POST" class="d-flex gap-2">
      <button type="submit" name="vote_value" value="1" 
              class="btn <%= userVote === 1 ? 'btn-success' : 'btn-outline-success' %>"
              <%= !locals.userId ? 'disabled' : '' %>>
        <i class="bi bi-hand-thumbs-up"></i>
        <%= solution.upvotes %>
      </button>
      <button type="submit" name="vote_value" value="-1" 
              class="btn <%= userVote === -1 ? 'btn-danger' : 'btn-outline-danger' %>"
              <%= !locals.userId ? 'disabled' : '' %>>
        <i class="bi bi-hand-thumbs-down"></i>
        <%= solution.downvotes %>
      </button>
    </form>
    <span class="ms-3">
      Total score: <%= solution.upvotes - solution.downvotes %>
    </span>
  </div>
  <% if (!locals.userId) { %>
    <small class="text-muted">Please log in to vote</small>
  <% } %>
</div>

<!-- Comments Section -->
<div class="mb-4">
  <h3>Comments</h3>
  <% if (comments.length > 0) { %>
    <ul class="list-group">
      <% comments.forEach(comment => { %>
        <li class="list-group-item mb-2">
          <strong><%= comment.author || 'Anonymous' %></strong> said:
          <p><%= comment.comment_text %></p>
          <% if (comment.images && comment.images.length > 0) { %>
            <div class="comment-images d-flex flex-wrap gap-2 mb-2">
              <% comment.images.forEach((image, index) => { %>
                <img 
                  src="/uploads/<%= image %>" 
                  alt="Comment image <%= index + 1 %>"
                  class="img-thumbnail"
                  style="height: 100px; object-fit: contain;"
                  onclick="showImagePreview(this, <%= index %>)"
                />
              <% }); %>
            </div>
          <% } %>
          <small><%= comment.created_at %></small>
        </li>
      <% }); %>
    </ul>
  <% } else { %>
    <p>No comments yet.</p>
  <% } %>
</div>

<!-- Add a new comment -->
<div>
  <h4>Add a Comment</h4>
  <form action="/sandbox/<%= solution.id %>/comment" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="comment_text" class="form-label">Comment</label>
      <textarea
        name="comment_text"
        id="comment_text"
        rows="3"
        class="form-control"
      ></textarea>
    </div>

    <div class="mb-3">
      <label for="comment_images" class="form-label">Images (optional)</label>
      <input
        type="file"
        name="comment_images"
        id="comment_images"
        class="form-control"
        accept="image/*"
        multiple
      />
    </div>

    <div class="mb-3">
      <label for="author" class="form-label">Author (optional)</label>
      <input
        type="text"
        name="author"
        id="author"
        class="form-control"
        placeholder="Your name or nickname"
      />
    </div>

    <button type="submit" class="btn btn-primary">Post Comment</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
  const modalImage = document.getElementById('previewModalImage');
  const prevButton = document.getElementById('prevImage');
  const nextButton = document.getElementById('nextImage');
  const counter = document.getElementById('imageCounter');
  let currentIndex = 0;
  let images = [];

  // Initialize images array
  if (document.querySelector('.solution-images')) {
    images = Array.from(document.querySelectorAll('.solution-images img'));
  }

  // Show image preview
  window.showImagePreview = function(img, index) {
    currentIndex = index;
    modalImage.src = img.src;
    updateNavigation();
    modal.show();
  };

  // Update navigation state
  function updateNavigation() {
    counter.textContent = `${currentIndex + 1}/${images.length}`;
    prevButton.style.display = images.length > 1 ? 'block' : 'none';
    nextButton.style.display = images.length > 1 ? 'block' : 'none';
  }

  // Navigation handlers
  prevButton.addEventListener('click', () => {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    modalImage.src = images[currentIndex].src;
    updateNavigation();
  });

  nextButton.addEventListener('click', () => {
    currentIndex = (currentIndex + 1) % images.length;
    modalImage.src = images[currentIndex].src;
    updateNavigation();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (modal._element.classList.contains('show')) {
      if (e.key === 'ArrowLeft') prevButton.click();
      if (e.key === 'ArrowRight') nextButton.click();
      if (e.key === 'Escape') modal.hide();
    }
  });

  // Image zoom toggle
  modalImage.addEventListener('click', function() {
    if (this.classList.contains('zoomed')) {
      this.style.transform = 'scale(1)';
      this.classList.remove('zoomed');
    } else {
      this.classList.add('zoomed');
      this.style.transform = 'scale(1.5)';
    }
  });
});
</script>

<%- include('../partials/footer') %>