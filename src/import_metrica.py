import requests

import pandas as pd
from io import StringIO

eng_sol = ['1.1.1', '1.1.2', '1.1.3', '1.1.4', '1.1.5', '1.1.6', '1.1.7', '1.1.8', '1.1.9', '1.1.10', '1.1.11', '1.1.12', '1.1.13', '1.1.14', '1.1.15', '1.1.16', '1.1.17', '1.1.18', '1.1.19', '1.1.20', '1.1.21', '1.1.22', '1.1.23', '1.2.1', '1.2.2', '1.2.3', '1.2.4', '1.2.5', '1.2.6', '1.2.7', '1.2.8', '1.2.9', '1.2.10', '1.2.11', '1.2.12', '1.2.13', '1.2.14', '1.2.19', '1.2.20', '1.2.21', '1.3.1', '1.3.2', '1.3.3', '1.3.4', '1.3.5', '1.3.6', '1.3.7', '1.3.8', '1.3.9', '1.3.10', '1.3.11', '1.3.12', '1.3.13', '1.3.14', '1.3.15', '1.3.16', '1.3.17', '1.3.18', '1.3.19', '1.3.20', '1.3.21', '1.3.22', '1.3.23', '1.3.24', '1.3.25', '1.3.26', '1.3.27', '1.3.28', '1.3.29', '1.3.30', '1.4.1', '1.4.2', '1.4.3', '1.4.4', '1.4.5', '1.4.7', '1.4.8', '1.4.9', '1.4.10', '1.4.11', '1.4.12', '1.4.13', '1.4.14', '1.4.15', '1.4.16', '1.4.17', '1.4.18', '1.5.1', '1.5.2', '1.5.3', '1.5.4', '1.5.5', '1.5.6', '1.5.7', '1.5.8', '1.5.9', '1.5.10', '1.5.11', '1.5.12', '1.5.13', '1.5.14', '1.5.15', '1.5.16', '1.5.17', '1.5.18', '1.5.19', '1.5.20', '2.1.1', '2.1.2', '2.1.3', '2.1.4', '2.1.5', '2.1.6', '2.1.7', '2.1.8', '2.1.9', '2.1.10', '2.1.11', '2.1.12', '2.1.13', '2.1.14', '2.1.15', '2.1.16', '2.1.17', '2.1.18', '2.1.19', '2.1.20', '2.1.21', '2.1.22', '2.1.23', '2.1.24', '2.1.25', '2.1.26', '2.1.28', '2.1.29', '2.1.30', '2.1.31', '2.1.32', '2.1.33', '2.1.34', '2.1.35', '2.1.36', '2.1.37', '2.1.38', '2.1.39', '2.1.40', '2.1.41', '2.1.42', '2.1.44', '2.1.45', '2.1.46', '2.1.47', '2.1.48', '2.1.49', '2.2.16', '2.2.23', '2.2.24', '2.2.29', '2.2.34', '2.2.37', '2.2.38', '2.2.39', '2.2.41', '2.2.42', '2.2.44', '2.3.30', '2.3.35', '2.3.36', '2.3.38', '2.3.39', '2.3.40', '2.3.41', '2.3.44', '2.3.45', '2.3.46', '2.3.48', '2.3.49', '2.4.1', '2.4.9', '2.4.12', '2.4.16', '2.4.17', '2.4.20', '2.4.34', '2.4.35', '2.5.9', '2.5.17', '2.5.18', '2.5.35', '2.5.36', '2.5.38', '2.6.14', '2.6.33', '2.6.36', '2.6.37', '2.6.41', '2.6.42', '2.6.43', '2.6.45', '2.6.46', '2.6.48', '2.6.52', '2.7.6', '2.7.19', '2.7.20', '2.7.27', '2.7.41', '2.7.42', '2.7.44', '2.8.1', '2.8.4', '2.8.11', '2.8.13', '2.8.14', '2.8.17', '2.8.25', '2.8.34', '2.8.37', '2.8.43', '3.1.1', '3.1.2', '3.1.3', '3.1.4', '3.1.5', '3.1.6', '3.1.7', '3.1.8', '3.1.9', '3.1.10', '3.1.11', '3.1.12', '3.1.15', '3.1.16', '3.1.17', '3.2.1', '3.2.2', '3.2.3', '3.2.4', '3.2.5', '3.2.6', '3.2.7', '3.2.8', '3.2.9', '3.2.10', '3.2.11', '3.2.12', '3.2.13', '3.2.14', '3.2.16', '3.2.17', '3.3.3', '3.3.8', '4.1.12', '4.1.13', '4.1.22', '4.2.6', '4.2.7', '4.2.11', '4.2.12', '4.2.13', '4.2.14', '4.2.26', '5.2.9', '5.3.1', '5.3.2', '5.3.3', '5.4.16', '5.5.3', '5.5.16', '5.6.22', '5.6.26', '5.6.31', '5.9.2', '5.9.3', '5.9.5', '5.9.10', '6.2.10', '6.2.11', '6.2.12', '6.2.13', '6.4.7', '6.5.1', '6.5.2', '7.1.3', '7.1.6', '7.1.12', '7.1.17', '7.1.22', '7.1.23', '7.3.9', '8.3.15', '9.1.1', '9.1.2', '9.1.3', '9.1.4', '9.1.5', '9.1.6', '9.1.7', '9.1.8', '9.1.9', '9.1.10', '9.1.11', '9.1.12', '9.1.13', '9.1.14', '9.1.15', '9.2.1', '9.2.2', '9.2.3', '9.2.4', '9.2.5', '9.2.6', '9.2.7', '9.2.8', '9.2.9', '9.2.10', '9.2.11', '9.2.12', '9.2.13', '9.2.14', '9.2.15', '9.2.16', '9.2.17', '9.3.2', '10.1.15', '10.2.8', '10.2.11', '10.2.12', '11.2.2', '11.5.11', '12.1.4', '13.2.11', '13.2.14']
rus_sol = ['1.1.1', '1.1.2', '1.1.3', '1.1.4', '1.1.5', '1.1.6', '1.1.7', '1.1.8', '1.1.9', '1.1.10', '1.1.11', '1.1.12', '1.1.13', '1.1.14', '1.1.15', '1.1.16', '1.1.17', '1.1.18', '1.1.19', '1.1.20', '1.1.21', '1.1.22', '1.1.23', '1.2.1', '1.2.2', '1.2.3', '1.2.4', '1.2.5', '1.2.6', '1.2.7', '1.2.8', '1.2.9', '1.2.10', '1.2.11', '1.2.12', '1.2.13', '1.2.14', '1.2.20', '1.2.21', '1.3.1', '1.3.2', '1.3.3', '1.3.4', '1.3.5', '1.3.6', '1.3.7', '1.3.8', '1.3.9', '1.3.10', '1.3.11', '1.3.12', '1.3.13', '1.3.14', '1.3.15', '1.3.16', '1.3.17', '1.3.18', '1.3.19', '1.3.20', '1.3.21', '1.3.22', '1.3.23', '1.3.24', '1.3.25', '1.3.26', '1.3.27', '1.3.28', '1.3.29', '1.3.30', '1.4.1', '1.4.2', '1.4.3', '1.4.4', '1.4.5', '1.4.6', '1.4.7', '1.4.8', '1.4.9', '1.4.10', '1.4.11', '1.4.12', '1.4.13', '1.4.14', '1.4.15', '1.4.16', '1.4.17', '1.4.18', '1.5.1', '1.5.2', '1.5.3', '1.5.4', '1.5.5', '1.5.6', '1.5.7', '1.5.8', '1.5.9', '1.5.10', '1.5.11', '1.5.12', '1.5.13', '1.5.14', '1.5.15', '1.5.16', '1.5.17', '1.5.18', '1.5.19', '1.5.20', '2.1.1', '2.1.2', '2.1.3', '2.1.4', '2.1.5', '2.1.6', '2.1.7', '2.1.8', '2.1.9', '2.1.10', '2.1.11', '2.1.12', '2.1.13', '2.1.14', '2.1.15', '2.1.16', '2.1.17', '2.1.18', '2.1.19', '2.1.20', '2.1.21', '2.1.22', '2.1.23', '2.1.24', '2.1.25', '2.1.26', '2.1.27', '2.1.28', '2.1.29', '2.1.30', '2.1.31', '2.1.32', '2.1.33', '2.1.34', '2.1.35', '2.1.36', '2.1.37', '2.1.38', '2.1.39', '2.1.40', '2.1.41', '2.1.42', '2.1.43', '2.1.44', '2.1.45', '2.1.46', '2.1.47', '2.1.48', '2.1.49', '2.1.50', '2.1.51', '2.1.52', '2.1.53', '2.1.54', '2.1.55', '2.1.56', '2.1.57', '2.1.58', '2.1.59', '2.1.60', '2.1.61', '2.1.62', '2.1.63', '2.1.64', '2.1.65', '2.1.66', '2.1.67', '2.2.1', '2.2.2', '2.2.3', '2.2.4', '2.2.5', '2.2.6', '2.2.7', '2.2.8', '2.2.9', '2.2.10', '2.2.11', '2.2.12', '2.2.13', '2.2.14', '2.2.15', '2.2.17', '2.2.18', '2.2.19', '2.2.20', '2.2.21', '2.2.22', '2.2.24', '2.2.25', '2.2.26', '2.2.27', '2.2.28', '2.2.29', '2.2.31', '2.2.32', '2.2.33', '2.2.35', '2.2.36', '2.2.43', '2.2.46', '2.2.47', '2.3.1', '2.3.2', '2.3.3', '2.3.4', '2.3.5', '2.3.6', '2.3.7', '2.3.8', '2.3.9', '2.3.10', '2.3.11', '2.3.12', '2.3.13', '2.3.14', '2.3.15', '2.3.16', '2.3.17', '2.3.18', '2.3.19', '2.3.20', '2.3.21', '2.3.23', '2.3.25', '2.3.26', '2.3.27', '2.3.28', '2.3.29', '2.3.32', '2.3.33', '2.3.34', '2.3.42', '2.3.47', '2.3.48', '2.4.2', '2.4.3', '2.4.4', '2.4.7', '2.4.8', '2.4.10', '2.4.11', '2.4.12', '2.4.13', '2.4.16', '2.4.18', '2.4.31', '2.4.42', '2.4.43', '2.5.1', '2.5.2', '2.5.3', '2.5.12', '2.5.19', '2.5.21', '2.5.23', '2.5.25', '2.5.34', '2.5.37', '2.5.39', '2.6.3', '2.6.16', '2.6.18', '2.6.19', '2.6.20', '2.6.21', '2.6.22', '2.6.23', '2.6.24', '2.6.25', '2.6.26', '2.6.27', '2.6.28', '2.6.29', '2.6.30', '2.6.31', '2.6.32', '2.6.33', '2.6.34', '2.6.38', '2.6.39', '2.6.40', '2.6.47', '2.6.49', '2.6.50', '2.6.53', '2.7.1', '2.7.2', '2.7.3', '2.7.4', '2.7.5', '2.7.6', '2.7.7', '2.7.9', '2.7.10', '2.7.11', '2.7.12', '2.7.13', '2.7.14', '2.7.15', '2.7.16', '2.7.17', '2.7.18', '2.7.19', '2.7.20', '2.7.21', '2.7.22', '2.7.23', '2.7.24', '2.7.26', '2.7.27', '2.7.28', '2.7.29', '2.7.30', '2.7.31', '2.7.33', '2.7.34', '2.7.35', '2.7.36', '2.7.40', '2.7.41', '2.7.42', '2.7.43', '2.7.44', '2.7.45', '2.7.46', '2.7.47', '2.7.48', '2.8.1', '2.8.2', '2.8.3', '2.8.6', '2.8.8', '2.8.9', '2.8.10', '2.8.11', '2.8.25', '3.1.1', '3.1.2', '3.1.3', '3.1.4', '3.1.5', '3.1.6', '3.1.7', '3.1.8', '3.1.9', '3.1.10', '3.1.11', '3.1.12', '3.1.15', '3.1.16', '3.1.17', '3.2.1', '3.2.2', '3.2.3', '3.2.4', '3.2.5', '3.2.6', '3.2.7', '3.2.8', '3.2.9', '3.2.10', '3.2.11', '3.2.12', '3.2.13', '3.2.14', '3.2.16', '3.2.17', '3.2.18', '3.2.19', '3.2.20', '3.2.21', '3.2.22', '3.2.23', '3.2.24', '3.2.25', '3.2.27', '3.2.28', '3.2.29', '3.2.30', '3.2.31', '3.2.33', '3.2.34', '3.2.35', '3.2.37', '3.3.1', '3.3.4', '3.3.5', '3.3.6', '3.3.7', '3.3.8', '3.3.10', '3.3.11', '3.3.15', '3.3.19', '3.3.36', '3.5.11', '4.1.2', '4.1.3', '4.1.4', '4.1.5', '4.1.6', '4.1.8', '4.1.14', '4.1.17', '4.1.22', '4.3.4', '4.3.12', '4.4.5', '4.5.10', '4.5.14', '4.6.16', '4.6.17', '5.1.1', '5.1.3', '5.1.4', '5.1.5', '5.1.6', '5.1.7', '5.1.8', '5.1.9', '5.1.11', '5.2.1', '5.2.2', '5.2.3', '5.2.4', '5.2.5', '5.2.6', '5.2.8', '5.2.10', '5.2.12', '5.2.13', '5.2.15', '5.2.17', '5.3.1', '5.3.2', '5.3.3', '5.3.4', '5.3.5', '5.3.6', '5.3.14', '5.4.1', '5.4.2', '5.4.3', '5.4.4', '5.4.5', '5.4.6', '5.4.7', '5.4.11', '5.4.12', '5.4.13', '5.4.14', '5.4.15', '5.5.2', '5.5.4', '5.5.6', '5.5.7', '5.5.8', '5.5.9', '5.5.10', '5.5.11', '5.5.12', '5.5.13', '5.5.15', '5.5.18', '5.5.19', '5.5.20', '5.5.21', '5.5.22', '5.5.23', '5.5.24', '5.5.25', '5.5.28', '5.5.30', '5.5.32', '5.5.34', '5.5.35', '5.5.36', '5.6.22', '5.6.28', '5.6.30', '5.9.18', '5.9.24', '5.10.1', '5.10.2', '5.10.5', '5.10.6', '5.10.7', '5.10.8', '5.10.14', '5.10.20', '5.10.21', '5.10.22', '5.10.23', '5.10.26', '5.10.27', '5.10.28', '5.10.29', '5.10.30', '5.10.31', '5.10.32', '5.10.33', '5.10.34', '5.10.35', '5.11.1', '5.11.2', '5.11.4', '5.11.5', '5.11.6', '5.11.7', '5.11.8', '5.11.9', '5.11.10', '5.11.11', '5.11.12', '6.1.1', '6.1.2', '6.1.3', '6.1.4', '6.1.5', '6.1.6', '6.1.7', '6.1.8', '6.1.9', '6.1.10', '6.1.11', '6.1.12', '6.1.13', '6.1.14', '6.1.15', '6.1.16', '6.1.17', '6.1.18', '6.1.19', '6.1.21', '6.3.11', '6.3.19', '6.3.23', '6.3.32', '6.4.12', '6.5.9', '6.5.10', '6.5.15', '6.5.24', '6.5.29', '6.6.20', '6.6.21', '6.6.25', '7.1.10', '7.1.24', '7.4.8', '7.4.22', '7.4.23', '8.1.1', '8.1.2', '8.1.8', '8.1.9', '8.1.10', '8.1.12', '8.1.14', '8.1.15', '8.1.19', '8.2.14', '8.2.15', '8.2.16', '8.3.1', '8.3.2', '8.3.3', '8.3.4', '8.3.5', '8.3.6', '8.3.9', '8.3.10', '8.3.11', '8.3.12', '8.3.13', '8.3.14', '8.3.15', '8.3.16', '8.3.17', '8.3.18', '8.3.19', '8.3.20', '8.3.21', '8.3.23', '8.3.24', '8.3.25', '8.3.26', '8.3.27', '8.3.28', '8.3.29', '8.3.30', '8.3.31', '8.3.32', '8.3.33', '8.3.34', '8.3.35', '8.3.36', '8.3.37', '8.3.38', '8.3.39', '8.3.40', '8.3.41', '8.3.42', '8.3.44', '8.3.45', '8.3.46', '8.3.47', '8.3.48', '8.4.1', '8.4.2', '8.4.4', '8.4.5', '8.4.7', '8.4.8', '8.4.9', '8.4.12', '8.4.13', '8.4.14', '8.4.15', '8.4.16', '8.4.18', '8.4.19', '8.4.20', '8.4.21', '9.1.1', '9.1.2', '9.1.3', '9.1.4', '9.1.5', '9.1.6', '9.1.7', '9.1.8', '9.1.9', '9.1.10', '9.1.11', '9.1.12', '9.1.13', '9.1.14', '9.1.15', '9.2.1', '9.2.2', '9.2.3', '9.2.4', '9.2.5', '9.2.6', '9.2.7', '9.2.8', '9.2.9', '9.2.10', '9.2.11', '9.2.12', '9.2.13', '9.2.14', '9.2.15', '9.2.16', '9.2.17', '9.3.6', '10.1.20', '10.1.21', '10.1.23', '10.2.2', '10.2.4', '10.2.5', '11.1.2', '11.1.3', '11.1.4', '11.1.5', '11.1.6', '11.1.7', '11.1.8', '11.1.9', '11.1.10', '11.1.11', '11.1.12', '11.1.13', '11.1.14', '11.1.15', '11.1.16', '11.1.17', '11.1.18', '11.1.19', '11.1.20', '11.1.21', '11.1.22', '11.1.23', '11.1.24', '11.1.25', '11.1.26', '11.1.31', '11.2.15', '13.2.20', '13.4.18']


def download_stat(URL_LINK, ID_NAME):
    API_URL = 'https://api-metrika.yandex.ru/stat/v1/data/bytime.csv'
    API_token = "your_default_token_here"
    params = {
        'date1': '500daysAgo',
        'date2': 'today',
        'id': ID_NAME,
        # 'metrics': 'ym:s:visits,ym:s:users',
        'metrics': 'ym:pv:pageviews',
        'group' : 'day',
        'filters': f"ym:pv:URLPathFull=='{URL_LINK}'",  # Filter to match the exact page
        'limit': 200
    }

    r = requests.get(API_URL, params = params, headers={'Authorization':API_token})

    return r.text

# http://api-metrika.yandex.ru/stat/content/popular.json?id=24540965&date1=20110501&date2=20150709&per_page=10000&pretty=1

import time, os

available_ids = [95301471, 98395701]


def process_problem(problem_name):
    filename = f"metrica/ru_{problem_name}.csv"

    if os.path.exists(filename):
        print("Scipping")
        return


    # print(problem_name, problem_name.split('.')[0])

    chapter_name = problem_name.split('.')[0]
    problem_names = [f'/ru/{problem_name}', f'/ru/{problem_name}/', f'/{chapter_name}/{problem_name}/', f'/{chapter_name}/{problem_name}']

    data_downloaded = []

    for id_name in available_ids:
        for url in problem_names:
            print(url)

            data = download_stat(url, id_name).replace('﻿', '').replace('"Период",""', '"Период","",""')
            # print(data.replace('﻿', ''))
            print(data)

            df = pd.read_csv(StringIO(data))
            df.columns = ["Период", "Value", ""]

            # print(df)

            data_downloaded.append(df)

            # print(data)


    for df in data_downloaded:
        df["Value"] = pd.to_numeric(df["Value"], errors='coerce')

    merged_df = data_downloaded[0].copy()
    for i in range(1, 8):
        print(i)
        merged_df["Value"] += data_downloaded[i]["Value"]


    merged_df.to_csv(filename, index=False, encoding="utf-8")
        


# for problem_name in rus_sol:
#     process_problem(problem_name)

from concurrent.futures import ThreadPoolExecutor


with ThreadPoolExecutor(max_workers=10) as executor:
    futures = [executor.submit(process_problem, problem_name) for problem_name in rus_sol]

# Wait for all futures to complete
for future in futures:
    future.result()



# r = requests.get(API_URL, params = params, headers={'Authorization':API_token})

# print(download_stat('/en/1.1.1').text)